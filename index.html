<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz & Earn BD</title>
    
    <!-- ফন্ট এবং আইকন -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- প্রয়োজনীয় স্ক্রিপ্ট -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Gigapub Ads Script -->
    <script src="https://ad.gigapub.tech/script?id=4203"></script>

    <style>
        :root {
            --primary: #6C5CE7;
            --primary-dark: #4834d4;
            --secondary: #00b894;
            --bg: #dfe6e9;
            --card-bg: #ffffff;
            --text: #2d3436;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* --- Header 3D Design --- */
        .header {
            background: linear-gradient(135deg, #6C5CE7, #a29bfe);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 8px 15px rgba(108, 92, 231, 0.3);
            color: white;
            position: sticky;
            top: 0; z-index: 100;
        }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .avatar { 
            width: 45px; height: 45px; border-radius: 50%; 
            border: 3px solid white; background: #eee; object-fit: cover;
        }
        .user-details h3 { margin: 0; font-size: 16px; font-weight: 700; }
        .user-details p { margin: 0; font-size: 11px; opacity: 0.8; }
        
        .balance-card {
            background: rgba(255, 255, 255, 0.25);
            padding: 8px 15px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(5px);
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .balance-card:active { transform: scale(0.95); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        .coin-icon { color: #F1C40F; text-shadow: 0 2px 2px rgba(0,0,0,0.2); font-size: 18px; }

        /* --- Categories 3D Grid --- */
        .container { padding: 20px; }
        .section-title {
            font-size: 18px; font-weight: 700; margin: 20px 0 15px;
            border-left: 5px solid var(--primary); padding-left: 10px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .card-3d {
            height: 120px;
            border-radius: 20px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; text-align: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2), 0 10px 10px rgba(0,0,0,0.1);
        }
        .card-3d:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
        }
        .card-3d i { font-size: 35px; margin-bottom: 8px; }
        
        .bg-bd { background: linear-gradient(135deg, #00b894, #00cec9); border-bottom: 6px solid #008b70; }
        .bg-int { background: linear-gradient(135deg, #0984e3, #74b9ff); border-bottom: 6px solid #065fa3; }
        .bg-gk { background: linear-gradient(135deg, #fdcb6e, #e17055); border-bottom: 6px solid #d35400; }
        .bg-isl { background: linear-gradient(135deg, #2ecc71, #27ae60); border-bottom: 6px solid #1e8449; }

        /* --- 3D Spin Button Section --- */
        .spin-trigger-section {
            margin-top: 30px;
            text-align: center;
        }
        .spin-3d-btn {
            background: linear-gradient(135deg, #FF7675, #D63031);
            color: white;
            border: none;
            width: 100%;
            padding: 20px;
            font-size: 22px;
            font-weight: 700;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 8px 0 #b71540, 0 15px 20px rgba(0,0,0,0.2);
            transition: all 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        .spin-3d-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 #b71540;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px;
            border-radius: 20px; padding: 20px; text-align: center;
            position: relative; animation: popIn 0.3s;
        }
        @keyframes popIn { from {transform: scale(0.5); opacity:0;} to {transform: scale(1); opacity:1;} }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }

        /* --- Spin Wheel UI --- */
        .wheel-wrapper { width: 250px; height: 250px; margin: 20px auto; position: relative; }
        .wheel {
            width: 100%; height: 100%; border-radius: 50%;
            border: 8px solid #6C5CE7;
            background: conic-gradient(#ff7675 0deg 60deg, #74b9ff 60deg 120deg, #55efc4 120deg 180deg, #ffeaa7 180deg 240deg, #a29bfe 240deg 300deg, #fd79a8 300deg 360deg);
            transition: transform 4s cubic-bezier(0.33, 1, 0.68, 1);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        .arrow {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent;
            border-right: 15px solid transparent; border-top: 30px solid #2d3436;
            z-index: 10; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
        }
        .spin-action-btn {
            background: var(--primary); color: white; padding: 12px 40px;
            border: none; border-radius: 50px; font-size: 18px; font-weight: bold;
            box-shadow: 0 5px 0 var(--primary-dark); cursor: pointer;
        }
        .spin-action-btn:active { transform: translateY(5px); box-shadow: none; }
        .spin-action-btn:disabled { background: #b2bec3; box-shadow: none; transform: none; }

        /* --- Quiz UI --- */
        .option-btn {
            display: block; width: 100%; padding: 12px; margin: 10px 0;
            background: #f1f2f6; border: 2px solid #dcdde1; border-radius: 10px;
            font-size: 16px; font-weight: 600; color: #2d3436; cursor: pointer;
        }
        .option-btn.correct { background: #55efc4; color: white; border-color: #00b894; }
        .option-btn.wrong { background: #ff7675; color: white; border-color: #d63031; }
        
        /* --- Withdraw Form --- */
        .input-field {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 2px solid #dfe6e9; border-radius: 10px; font-family: inherit;
        }
        .submit-btn {
            width: 100%; padding: 15px; background: #00b894; color: white;
            border: none; border-radius: 10px; font-weight: bold; font-size: 16px;
        }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="user-profile">
            <img src="https://via.placeholder.com/45" id="userImg" class="avatar" alt="Profile">
            <div class="user-details">
                <h3 id="userName">অপেক্ষা করুন...</h3>
                <p id="userID">ID: Loading...</p>
            </div>
        </div>
        <div class="balance-card" onclick="openModal('withdrawModal')">
            <i class="fas fa-coins coin-icon"></i>
            <span id="balanceDisplay" style="font-weight: 700;">0</span>
        </div>
    </div>

    <div class="container">
        <!-- Quiz Section -->
        <div class="section-title">কুইজ ক্যাটাগরি</div>
        <div class="grid">
            <div class="card-3d bg-bd" onclick="startQuiz('bangladesh')">
                <i class="fas fa-flag"></i> <span>বাংলাদেশ</span>
            </div>
            <div class="card-3d bg-int" onclick="startQuiz('international')">
                <i class="fas fa-globe-americas"></i> <span>আন্তর্জাতিক</span>
            </div>
            <div class="card-3d bg-gk" onclick="startQuiz('gk')">
                <i class="fas fa-brain"></i> <span>সাধারণ জ্ঞান</span>
            </div>
            <div class="card-3d bg-isl" onclick="startQuiz('islamic')">
                <i class="fas fa-mosque"></i> <span>ইসলামিক</span>
            </div>
        </div>

        <!-- Spin Button Section -->
        <div class="spin-trigger-section">
            <button class="spin-3d-btn" onclick="openSpinModal()">
                <i class="fas fa-dharmachakra"></i> লাকি স্পিন হুইল
            </button>
            <p style="margin-top: 10px; color: #636e72; font-size: 14px;">
                আজকের স্পিন বাকি: <span id="spinsLeftDisplay" style="font-weight:bold; color: #d63031;">0</span> টি
            </p>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('quizModal')">&times;</span>
            <h4 id="quizTitle" style="color: var(--primary);">প্রশ্ন</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <h3 id="questionText">Loading...</h3>
            </div>
            <div id="optionsContainer"></div>
            <p style="font-size: 12px; color: #aaa;">প্রশ্ন <span id="qCount">0</span>/10</p>
        </div>
    </div>

    <!-- Spin Modal -->
    <div id="spinModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('spinModal')">&times;</span>
            <h3>লাকি স্পিন</h3>
            <div class="wheel-wrapper">
                <div class="arrow"></div>
                <div class="wheel" id="wheel"></div>
            </div>
            <button id="doSpinBtn" class="spin-action-btn" onclick="performSpin()">স্পিন করুন</button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('withdrawModal')">&times;</span>
            <h3>পেমেন্ট মেথড</h3>
            <p>ব্যালেন্স: <span id="wBalance" style="color:var(--secondary); font-weight:bold;">0</span> কয়েন</p>
            
            <select id="wMethod" class="input-field">
                <option value="bkash">বিকাশ</option>
                <option value="nagad">নগদ</option>
                <option value="rocket">রকেট</option>
                <option value="recharge">মোবাইল রিচার্জ</option>
            </select>
            <input type="number" id="wAmount" class="input-field" placeholder="পরিমাণ (মিনিমাম ৩০০০)">
            <input type="number" id="wNumber" class="input-field" placeholder="নাম্বার দিন">
            
            <button class="submit-btn" onclick="submitWithdraw()">রিকোয়েস্ট পাঠান</button>
        </div>
    </div>

    <script>
        // --- কনফিগারেশন ---
        const SUPABASE_URL = 'https://uzrxrnqdozmuycxqtwkg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6cnhybnFkb3ptdXljeHF0d2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NzE1NzcsImV4cCI6MjA3OTA0NzU3N30.QttTbmRVeC7RsdHLJKIOccb4qTVCUEleZk3sIwHVVqQ';
        
        // --- ইনিশিয়ালাইজেশন ---
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram.WebApp;
        tg.expand(); // অ্যাপ ফুল স্ক্রিন করা

        // গ্লোবাল ভেরিয়েবল
        let currentUser = null;
        let currentBalance = 0;
        let dailySpins = 0;
        let quizScore = 0;
        let quizIndex = 0;
        let activeQuiz = [];

        // --- অ্যাপ শুরু (Start App) ---
        async function initApp() {
            // ১. টেলিগ্রাম ইউজার ডাটা নেওয়া
            let tgUser = tg.initDataUnsafe?.user;

            // ডিবাগিং বা ব্রাউজারে টেস্টিং এর জন্য ডামি ডাটা (যদি টেলিগ্রামে না থাকে)
            if (!tgUser) {
                console.warn("Telegram User not found. Using demo user.");
                tgUser = { id: 11223344, first_name: "Test", username: "User", photo_url: "https://via.placeholder.com/50" };
            }

            // UI আপডেট
            document.getElementById('userName').innerText = tgUser.first_name;
            document.getElementById('userID').innerText = "ID: " + tgUser.id;
            if (tgUser.photo_url) document.getElementById('userImg').src = tgUser.photo_url;

            // ২. ডাটাবেস চেক করা বা ইউজার তৈরি করা
            await syncUserWithDB(tgUser);
        }

        // --- ডাটাবেস সিঙ্ক (Sync User) ---
        async function syncUserWithDB(tgUser) {
            // ইউজার খোঁজা
            let { data: user, error } = await supabase
                .from('users')
                .select('*')
                .eq('telegram_id', tgUser.id)
                .single();

            const today = new Date().toISOString().split('T')[0];

            if (!user) {
                // নতুন ইউজার তৈরি
                const { data: newUser, error: insertError } = await supabase
                    .from('users')
                    .insert([{ 
                        telegram_id: tgUser.id, 
                        first_name: tgUser.first_name, 
                        username: tgUser.username,
                        spins_left: 10,
                        last_active_date: today
                    }])
                    .select()
                    .single();
                
                if (insertError) console.error(insertError);
                user = newUser;
            } else {
                // ডেট চেক (নতুন দিন হলে স্পিন রিসেট)
                if (user.last_active_date !== today) {
                    await supabase.from('users').update({ spins_left: 10, last_active_date: today }).eq('telegram_id', tgUser.id);
                    user.spins_left = 10;
                }
            }

            // ডাটা সেট করা
            currentUser = user;
            currentBalance = user.balance || 0;
            dailySpins = user.spins_left;
            
            updateUI();
        }

        function updateUI() {
            document.getElementById('balanceDisplay').innerText = currentBalance;
            document.getElementById('wBalance').innerText = currentBalance;
            document.getElementById('spinsLeftDisplay').innerText = dailySpins;
        }

        // --- কুইজ লজিক ---
        const questionsDB = {
            bangladesh: [
                { q: "বাংলাদেশের জাতীয় ফুল কোনটি?", o: ["গোলাপ", "শাপলা", "জবা", "পদ্ম"], a: 1 },
                { q: "বিজয় দিবস কবে?", o: ["২৬ মার্চ", "১৬ ডিসেম্বর", "২১ ফেব্রুয়ারি", "১ মে"], a: 1 },
                { q: "পদ্মা সেতুর দৈর্ঘ্য কত?", o: ["৬.১৫ কিমি", "৫.৫ কিমি", "৭ কিমি", "৪.৮ কিমি"], a: 0 },
                { q: "বাংলাদেশের রাজধানী কী?", o: ["খুলনা", "বরিশাল", "ঢাকা", "সিলেট"], a: 2 },
                { q: "জাতীয় কবি কে?", o: ["নজরুল ইসলাম", "রবীন্দ্রনাথ", "জসীমউদ্দীন", "জীবনানন্দ"], a: 0 },
                { q: "সুন্দরবন কোন জেলায়?", o: ["খুলনা", "ঢাকা", "রাজশাহী", "রংপুর"], a: 0 },
                { q: "টাকার নোটে কার ছবি থাকে?", o: ["বাঘ", "বঙ্গবন্ধু", "হরিণ", "দোয়েল"], a: 1 },
                { q: "বাংলাদেশের সবচেয়ে বড় জেলা কোনটি?", o: ["ঢাকা", "রাঙ্গামাটি", "কুমিল্লা", "বগুড়া"], a: 1 },
                { q: "জাতীয় খেলা কোনটি?", o: ["ক্রিকেট", "ফুটবল", "হাডুডু", "হকি"], a: 2 },
                { q: "মুক্তিযুদ্ধ কত সালে হয়?", o: ["১৯৫২", "১৯৭১", "১৯৯০", "১৯৪৭"], a: 1 }
            ],
            // আন্তর্জাতিক এবং অন্যান্য ক্যাটাগরির জন্য একই ফরম্যাটে প্রশ্ন যোগ করতে পারেন। ডেমোর জন্য সব এক রাখা হলো।
            international: [], gk: [], islamic: [] 
        };

        // অন্য ক্যাটাগরিতে ডেমো ডাটা কপি (যাতে এরর না খায়)
        questionsDB.international = questionsDB.bangladesh;
        questionsDB.gk = questionsDB.bangladesh;
        questionsDB.islamic = questionsDB.bangladesh;

        function startQuiz(category) {
            activeQuiz = questionsDB[category].sort(() => 0.5 - Math.random()).slice(0, 10); // ১০ টি প্রশ্ন
            quizIndex = 0;
            quizScore = 0;
            document.getElementById('quizModal').style.display = "flex";
            loadQuestion();
        }

        function loadQuestion() {
            if (quizIndex >= 10) {
                // কুইজ শেষ
                finishQuiz();
                return;
            }
            
            const q = activeQuiz[quizIndex];
            document.getElementById('questionText').innerText = q.q;
            document.getElementById('qCount').innerText = quizIndex + 1;
            
            const div = document.getElementById('optionsContainer');
            div.innerHTML = '';
            
            q.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(idx, q.a, btn);
                div.appendChild(btn);
            });
        }

        function checkAnswer(selected, correct, btn) {
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                quizScore++;
            } else {
                btn.classList.add('wrong');
                allBtns[correct].classList.add('correct');
            }

            setTimeout(() => {
                quizIndex++;
                loadQuestion();
            }, 1000);
        }

        function finishQuiz() {
            closeModal('quizModal');
            
            // ১০ টি কুইজ শেষ, এখন অ্যাড দেখাবে
            Swal.fire({
                title: 'কুইজ শেষ!',
                text: 'আপনার রিওয়ার্ড পেতে বিজ্ঞাপনটি দেখুন।',
                icon: 'info',
                confirmButtonText: 'ওকে'
            }).then(() => {
                showAdAndReward(5); // ৫ কয়েন রিওয়ার্ড
            });
        }

        // --- স্পিন লজিক ---
        function openSpinModal() {
            document.getElementById('spinModal').style.display = "flex";
        }

        function performSpin() {
            if (dailySpins <= 0) {
                Swal.fire('দুঃখিত', 'আজকের স্পিন শেষ!', 'error');
                return;
            }

            const btn = document.getElementById('doSpinBtn');
            const wheel = document.getElementById('wheel');
            btn.disabled = true;

            // এনিমেশন
            const deg = Math.floor(3000 + Math.random() * 3000);
            wheel.style.transform = `rotate(${deg}deg)`;

            setTimeout(() => {
                // স্পিন শেষ
                dailySpins--;
                updateSpinInDB(dailySpins); // ডাটাবেস আপডেট
                
                Swal.fire({
                    title: 'অভিনন্দন!',
                    text: 'স্পিন সম্পন্ন হয়েছে। রিওয়ার্ড পেতে বিজ্ঞাপন দেখুন।',
                    icon: 'success'
                }).then(() => {
                    // স্পিন শেষে অ্যাড শো এবং রিওয়ার্ড
                    showAdAndReward(5); // ৫ কয়েন
                    
                    // রিসেট হুইল
                    wheel.style.transition = 'none';
                    wheel.style.transform = 'rotate(0deg)';
                    setTimeout(() => { 
                        wheel.style.transition = 'transform 4s cubic-bezier(0.33, 1, 0.68, 1)'; 
                        btn.disabled = false;
                    }, 100);
                });
                
                updateUI();
            }, 4000);
        }

        async function updateSpinInDB(newCount) {
            await supabase.from('users').update({ spins_left: newCount }).eq('telegram_id', currentUser.telegram_id);
        }

        // --- Gigapub Ads এবং Reward ---
        function showAdAndReward(amount) {
            // Gigapub Show Function
            if (window.showGiga) {
                window.showGiga().then(() => {
                    // অ্যাড সফলভাবে দেখা হয়েছে
                    addBalance(amount);
                    Swal.fire('সফল!', `আপনি ${amount} কয়েন পেয়েছেন।`, 'success');
                }).catch((e) => {
                    console.error(e);
                    // অ্যাড লোড না হলেও রিওয়ার্ড দেওয়া (ইউজার এক্সপেরিয়েন্স ঠিক রাখতে)
                    addBalance(amount);
                    Swal.fire('অভিনন্দন', `অ্যাড লোড হয়নি, তবে আপনি ${amount} কয়েন পেয়েছেন!`, 'success');
                });
            } else {
                console.warn("Gigapub script not loaded");
                addBalance(amount);
            }
        }

        async function addBalance(amount) {
            const newBalance = currentBalance + amount;
            currentBalance = newBalance;
            updateUI();
            
            // ডাটাবেসে আপডেট
            await supabase
                .from('users')
                .update({ balance: newBalance })
                .eq('telegram_id', currentUser.telegram_id);
        }

        // --- উইথড্রয়াল ---
        async function submitWithdraw() {
            const method = document.getElementById('wMethod').value;
            const amount = parseInt(document.getElementById('wAmount').value);
            const number = document.getElementById('wNumber').value;

            if (!amount || !number) {
                Swal.fire('ত্রুটি', 'সব তথ্য সঠিক দিন', 'warning');
                return;
            }
            if (amount < 3000) {
                Swal.fire('ত্রুটি', 'মিনিমাম ৩০০০ কয়েন প্রয়োজন', 'warning');
                return;
            }
            if (amount > currentBalance) {
                Swal.fire('ত্রুটি', 'আপনার পর্যাপ্ত ব্যালেন্স নেই', 'error');
                return;
            }

            // ব্যালেন্স কাটা
            await addBalance(-amount);

            // উইথড্র রিকোয়েস্ট জমা
            const { error } = await supabase
                .from('withdrawals')
                .insert([{ 
                    telegram_id: currentUser.telegram_id, 
                    method: method, 
                    amount: amount, 
                    number: number 
                }]);

            if (error) {
                Swal.fire('সার্ভার ত্রুটি', 'পরে চেষ্টা করুন', 'error');
                await addBalance(amount); // রিফান্ড
            } else {
                closeModal('withdrawModal');
                Swal.fire('সফল!', 'আপনার রিকোয়েস্ট জমা হয়েছে। এডমিন চেক করে পেমেন্ট করবে।', 'success');
            }
        }

        // --- ইউটিলিটি ---
        function openModal(id) { document.getElementById(id).style.display = "flex"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }

        // অ্যাপ চালু
        window.onload = initApp;

    </script>
</body>
</html>
